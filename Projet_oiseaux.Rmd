---
title: "Projet"
output: 
  html_document:
    code_folding: hide
    code_download: true
    theme: united
    highlight: tango
    df_print: paged
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
date: "`r format(Sys.Date(), '%d %B, %Y')`"
author:
   - name: ""
     affiliation: "Université de Bordeaux - CMI ISI M1 - UE : Projet de statistique pour données environnementales 2024"
---
title: "Projet oiseaux"
output: html_document
date: "2024-02-19"
---

```{r}
library(dplyr)
library(sp)
library(leaflet)
library(ggplot2)
library(FactoMineR)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
Sites <- read.csv("Data/BiodiverCite_sites.csv", header = TRUE, sep = ";")
Land_cartoISea <- read.csv("Data/LandUsePer_BM_2023_cartoISea.csv", header = TRUE)
Oiseaux <- read.csv("Data/Oiseaux_up_to_2023.csv", header = TRUE, sep = "\t")
Traits <- read.csv("Data/traits-statut-IUCN-biodivercite.csv", header = TRUE, sep = ",")
```

```{r}
head(Sites)
```

```{r}
nrow(Land_cartoISea)
```
Pour chaque point on a 5 tailles de buffer --> 53x5

```{r}
head(Land_cartoISea)
```

```{r}
head(Oiseaux)
```

```{r}
head(Traits)
```

```{r}
Oiseaux$Nom_Latin <- sapply(strsplit(Oiseaux$Nom_Taxon_Cite, "\\|"), function(x) trimws(x[1]))
Oiseaux$Year <- sapply(strsplit(Oiseaux$Date, "\\-"), function(x) trimws(x[1]))
print(Oiseaux)
```

```{r}
#renommer la 4éme colonne
names(Traits)[4] = "Milieu_favori"
```

## 1ere question : 

Nous commençons par nous intéresser au buffer de taille 500m ce qui nous donnera un diamètre de 1km par rapport à chaque point.

```{r}
lambert_data <- data.frame(X = Land_cartoISea$X, Y = Land_cartoISea$Y)
coordinates(lambert_data) <- c("X", "Y")

proj4string(lambert_data) <- CRS("+proj=lcc +lat_1=48 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +units=m +no_defs")

wgs84 <- CRS("+proj=longlat +datum=WGS84")

lambert_to_wgs84 <- spTransform(lambert_data, wgs84)

countryPolygons.df <- as.data.frame(lambert_to_wgs84)
```

```{r}
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x1"] <- "X"
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x2"] <- "Y"
Land_cartoISea <- select(Land_cartoISea, -X, -Y)
Land_cartoISea <- cbind(Land_cartoISea, countryPolygons.df)
Land_cartoISea_500 <- subset(Land_cartoISea, BufferSize == 500)
```

```{r}
table_jointe_tbl <- Sites %>% 
                        left_join(y = Land_cartoISea_500, 
                                  by = c("code_site" = "ID"))
```

```{r}
palette <- colorNumeric(palette = "magma",domain = table_jointe_tbl$MOS11,reverse=TRUE)

amp_artificial <- leaflet(data = table_jointe_tbl) %>% 
  addTiles() %>%
  addCircles(~X.y, ~Y, weight = 1, radius = ~BufferSize, color = ~palette(MOS11), opacity = 1, fillOpacity = 0.5, popup = ~name_site)

amp_artificial <- amp_artificial %>% addLegend(position = "bottomright", pal = palette, values = ~MOS11, title = "MOS11", opacity = 1)

amp_artificial
```

On peut déjà voir une corrélation au niveau de l'artificialisation. Les lieux situés dans le centre ville de Bordeaux et des villes aux alentours ont tendances à avoir un pourcentage d'artificialisation supérieur (environ 60%) par rapport à ceux en périphérie de la ville (environ 10%).

```{r}
###on join les df Land_cartoISea_500 et Oiseaux 
data_join <- Oiseaux %>% left_join(y = Land_cartoISea_500, by = c("Code_Maille" = "ID"))

res <- data_join %>%
  group_by(MOS11, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res, aes(x = MOS11, y = Nb_espece, color = Year)) +
  geom_point() +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation")
```

On peut ici observer la corrélation par point entre le nombre d'espèce et le pourcentage d'artificialisation, chaque point correspondant à une espèce. 

Relation non linéaire en forme de cloche : La relation entre la biodiversité et l'imperméabilisation du sol peut suivre une courbe en forme de cloche, où la biodiversité est maximale à un certain niveau d'imperméabilisation du sol, puis diminue à mesure que l'imperméabilisation augmente davantage. Cela peut être dû à des seuils écologiques ou à des effets de perturbation qui sont plus prononcés à des niveaux intermédiaires d'imperméabilisation.

```{r}
# Filtre des données pour ne garder que l'année 2018
res_2018 <- res %>% filter(Year == 2018)
ggplot(data = res_2018, aes(x = MOS11, y = Nb_espece)) +
  geom_point(color = "blue") +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation \n(année 2018)")
```

Le nombre d'espèce a l'air assez constant sur l'année 2018. En effet, on remarque un léger pic à 10% d'artificialisation qui se stabilise après entre 20 et 40% d'artificialisation avec quand même une légère baisse à partir de 30%.

```{r}
# Filtre des données pour ne garder que l'année 2019
res_2018 <- res %>% filter(Year == 2019)
ggplot(data = res_2018, aes(x = MOS11, y = Nb_espece)) +
  geom_point(color = "blue") +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation \n(année 2019)")
```

On remarque ici aussi un pic au niveau des 10% d'artificialisation puis un résultat assez constant. Ce qui peut parraitre surprenant c'est qu'avec 0% d'artificialisation on avait environ 25 espèces alors qu'avec presque 30% d'artificialisation, on a environ 26 espèces. Le nombre d'espèces observées augmente avec l'artificialisation ??

```{r}
# Filtre des données pour ne garder que l'année 2022
res_2018 <- res %>% filter(Year == 2022)
ggplot(data = res_2018, aes(x = MOS11, y = Nb_espece)) +
  geom_point(color = "blue") +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation \n(année 2022)")
```

ATTENTION À L'INTERPRÉTATION CAR LES ECHELLES NE SONT PAS LES MÊMES SUR L'AXE DES ABSCISSES
En 2023, on observe une nouvelle fois un pic proche des 10% d'artificialisation et après une chute jusqu'au 60% d'artificialisation. Comment peut-on expliquer cette chute ?

```{r}
# Filtre des données pour ne garder que l'année 2023
res_2018 <- res %>% filter(Year == 2023)
ggplot(data = res_2018, aes(x = MOS11, y = Nb_espece)) +
  geom_point(color = "blue") +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation \n(année 2023)")
```

ATTENTION À L'INTERPRÉTATION CAR LES ECHELLES NE SONT PAS LES MÊMES SUR L'AXE DES ABSCISSES
On voit que les tendances changent, surtout en 2023 avec un nombre d'espèces qui semble d'augmenter avec le pourcentage d'artificialisation. On a toujours le pic au niveau des 10% et ensuite, au lieu d'avoir un nombre d'espèces qui diminue considérablement, on a une courbe qui se maintient plutôt bien. On remarque même que cette dernière semble monter vers la fin, que peut-on en déduire ??

On remarque que les tendances du nombre d'espèces changent mais nous ne savons pas vraiment comment l'expliquer. Nous pouvons à présent supposer qu'une autre variable explicative doit pouvoir nous aider à les comprendre. Nous allons donc maintenant nous intéresser aux variables ambiantes :  la température, le vent et la couverture nuageuse pour essayer de comprendre les variations au sujet du nombre d'espèces. 

Relation en U inversé : Dans certains écosystèmes, une relation en U inversé peut être observée, où la biodiversité diminue initialement avec l'imperméabilisation du sol, puis augmente à mesure que l'imperméabilisation atteint des niveaux extrêmes. Cela peut être dû à des processus de succession écologique, ou à des changements de l'environnement qui favorisent certaines espèces spécialisées.

On commence par s'intéresser à la température. 

```{r}
data_2018 <- data_join %>%
  filter(Year == 2018)

res_temperature <- data_2018 %>%
  group_by(Temperature, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_temperature, aes(x = Temperature, y = Nb_espece, color = as.factor(Year))) +
  geom_point() +
  geom_line() +
  labs(x = "Température",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la température (année 2018)")
```

On remarque une forme de parabole. Autour des 10°C, c'est à cette dernière qu'on observe le plus grand nombre d'espèces d'oiseaux (environ 64 espèces différentes).

```{r}
data_2019 <- data_join %>%
  filter(Year == 2019)

res_temperature <- data_2019 %>%
  group_by(Temperature, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_temperature, aes(x = Temperature, y = Nb_espece, color = as.factor(Year))) +
  geom_point() +
  geom_line() +
  labs(x = "Température",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la température (année 2019)")
```
Changement dasn les températures qui a impacté l'observations des oiseaux -> plus chaud plus tôt donc des oiseaux qui avaient migré n'étaient pas encore revenus et inversement.
Pic de prédation -> peu probable.
En 2019 la courbe est très différente de celle de 2018. En effet, à 15°C on observe une chute du nombre d'espèces qui pourrait être causé par un événement spécifique à cette période de l'année. Cela pourrait inclure des phénomènes météorologiques extrêmes, des perturbations humaines, ou des événements écologiques particuliers (comme par exemple un pic de prédation). Nous allons comparer les autres données météorologiques que nous possédons pour comparer ce résultat avec ceux des autres années.

```{r}
data_2022 <- data_join %>%
  filter(Year == 2022)

res_temperature <- data_2022 %>%
  group_by(Temperature, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_temperature, aes(x = Temperature, y = Nb_espece, color = as.factor(Year))) +
  geom_point() +
  geom_line() +
  labs(x = "Température",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la température (année 2022)")
```

On retrouve une forme de parabole qu'on observait déjà en 2018, cependant, on voit que le nombre d'espèces à 20°C est bien supérieur à celui de 2018. On retrouve un pic à 15°C qu'on avait perdu en 2019, ainsi qu'un nombre d'espèces à 10°C qui est légèrement plus faible qu'en 2018.

```{r}
data_2023 <- data_join %>%
  filter(Year == 2023)

res_temperature <- data_2023 %>%
  group_by(Temperature, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_temperature, aes(x = Temperature, y = Nb_espece, color = as.factor(Year))) +
  geom_point() +
  geom_line() +
  labs(x = "Température",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la température (année 2023)")
```
Finalement en 2023, on a encore cette forme de parabole mais qui s'atténue. En effet, on a un pic à 10°C mais la descente est ensuite plus douce jusqu'à 20°C : on a donc plus d'espèces d'oiseaux différentes en 2023 qu'en 2018.

Maintenant on regarde le niveau du vent.

```{r}
# Convertir la colonne "Vent" en facteur
data_join$Vent <- factor(data_join$Vent, levels = c("0 - Calme", "1 - Très légère brise", "2 - Légère brise", "3 - Petite brise"))

# Créer un résumé du nombre d'espèces par niveau de vent
res_vent <- data_join %>%
  group_by(Vent) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

# Créer le graphique
ggplot(data = res_vent, aes(x = Vent, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Vent",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du niveau de vent")
```
Difficile à interpréter parce que le niveau de vent aura un impact sur si on entend les oiseaux ou pas --> plus y'a de vent, moins on entend les oiseaux.

On remarque que le vent n'a pas un impact significatif dans l'évolution du nombre d'espèces d'oiseaux car ce dernier reste assez constant avec une légère baisse lorsque le vent se fait ressentir un peu plus.

Je sais pas si ça sert a quelque chose d'analyser pour chaque année sachant que quand on fait sur toutes les années y'a pas grand chose à interpréter. Je mets le code pour une année et on aura juste à la changer pour tout avoir. 

```{r}
res_vent <- data_join %>%
  filter(Year == 2018) %>%
  group_by(Vent) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

# Créer le graphique
ggplot(data = res_vent, aes(x = Vent, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Vent",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du niveau de vent (année 2018)")
```

Dans Couvert Nuageux, comme dans la qualité du Vent, les valeurs sont à la fois numériques et du texte, on a changé pour avoir des groupes, ainsi : 
- 1 : 0-25%
- 2 : 25-50%
- 3 : 50-75%
- 4 : 75-100%
- 5 : 100%
- 6 : Aucun
```{r}
niveaux <- c("0-25%", "25-50%", "50-75%", "75-100%", "100,00 %", "Aucun")
valeurs_numeriques <- c(1, 2, 3, 4, 5, 6)
data_join$Couvert_Nuageux_factor <- factor(data_join$Couvert_Nuageux, levels = niveaux)
data_join$Couvert_Nuageux_factor <- valeurs_numeriques[match(data_join$Couvert_Nuageux_factor, niveaux)]
```

Et finalement la couverture nuageuse.

```{r}
# Créer un résumé du nombre d'espèces par niveau de couverture nuageuse
res_couverture_nuageuse <- data_join %>%
  group_by(Couvert_Nuageux_factor) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

# Créer le graphique
ggplot(data = res_couverture_nuageuse, aes(x = Couvert_Nuageux_factor, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Couverture Nuageuse",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la couverture nuageuse")
```
Pareil pour la couverture nuageuse, je mets seulement 2018 et on aura juste à changer l'année pour avoir les autres

```{r}
# Créer un résumé du nombre d'espèces par niveau de couverture nuageuse
res_couverture_nuageuse_2018 <- data_join %>%
  filter(Year == 2018) %>%
  group_by(Couvert_Nuageux_factor) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

# Créer le graphique
ggplot(data = res_couverture_nuageuse_2018, aes(x = Couvert_Nuageux_factor, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Couverture Nuageuse",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la couverture nuageuse (année 2018)")
```

On fait maintenant une ACP, pour essayer de voir si la variabilité du nombre d'espèces est expliquée par l'artificialisation ou si elle peut être expliquée par d'autres variables ambiantes.

```{r}
data_join$Vent_nombre <- as.numeric(gsub("\\D", "", data_join$Vent))
data_join
```

```{r}
variables <- data_join %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
variables <- data_join %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```


- Axes d'inertie : Le graphique montre deux dimensions principales. La première dimension (Dim 1) explique 27,96% de la variance tandis que la deuxième dimension (Dim 2) en explique 23,34%. Ensemble, ces deux dimensions expliquent un peu plus de la moitié de la variance totale.
- Corrélation des variables avec les axes :
Le vent semble être fortement corrélé avec la deuxième dimension et, dans une moindre mesure, avec la première dimension.
Les variables "Couvert_Nuageux_factor" et "Température" sont alignées de manière similaire.
La variable "MOS1" est fortement corrélée avec la première dimension et peu corrélée avec la deuxième dimension.
- Interprétation :
La température est une variable importante pour expliquer le nombre d'espèces d'oiseaux.
Les variables "Vent_nombre" et "Couvert_Nuageux_factor" semblent être des facteurs importants qui ont une relation négative avec le nombre d'espèces d'oiseaux. Cela signifie que des conditions plus venteuses ou plus nuageuses pourraient être associées à une diminution du nombre d'espèces observées.
La variable MOS11 est négativement corrélée avec Nb_espece, cela signique que quand le MOS11 augmente, le nombre d'espèces quand à lui diminue ce qui semble être cohérent.
Le fait que "Nb_espece" ne soit pas fortement corrélé avec l'un ou l'autre des axes principaux suggère que d'autres facteurs non inclus dans cette analyse pourraient également jouer un rôle important (comme un pic de prédation).

```{r}
variables <- data_join %>%
  filter(Year == 2018) %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
```

```{r}
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

```{r}
variables <- data_join %>%
  filter(Year == 2018) %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
variables <- data_join %>%
  filter(Year == 2019) %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

```{r}
variables <- data_join %>%
  filter(Year == 2019) %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

En 2019, on retrouve des résultats surprenants, comme pour le nombre d'espèces en fonction de l'artificialisation. En effet, sur ce cercle de corrélation, on peux interpréter la chose suivante : le nombre d'espèces augmente avec l'artificialisation. Cependant, nous avions déjà des résultats surprenants avant, et la variable MOS11 étant mal projetée, on en déduit donc qu'elle n'est pas interprétable dans ce cas précis.

```{r}
variables <- data_join %>%
  filter(Year == 2022) %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
variables <- data_join %>%
  filter(Year == 2022) %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
variables <- data_join %>%
  filter(Year == 2023) %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
variables <- data_join %>%
  filter(Year == 2023) %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

2023 est certainement l'année qui explique le mieux notre problème initial. En effet, on remarque que le premier axe est très corrélé avec les variables ambiantes. De plus, les variables MOS11 et Nb_espece sont extrèmement corrélées négativement, avec un coefficient proche de -1. Cela signifie que quand l'aritficialisation augmente, le nombre d'espèces diminue, avec une relation quasiment linéaire.

## Pour 2000m de rayon donc 4000m de diamètre
```{r}
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x1"] <- "X"
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x2"] <- "Y"
Land_cartoISea <- select(Land_cartoISea, -X, -Y)
Land_cartoISea <- cbind(Land_cartoISea, countryPolygons.df)
Land_cartoISea_2000 <- subset(Land_cartoISea, BufferSize == 2000)
table_jointe_tbl <- Sites %>% 
                        left_join(y = Land_cartoISea_2000, 
                                  by = c("code_site" = "ID"))

palette <- colorNumeric(palette = "magma",domain = table_jointe_tbl$MOS11,reverse = TRUE)

amp_artificial <- leaflet(data = table_jointe_tbl) %>% 
  addTiles() %>%
  addCircles(~X.y, ~Y, weight = 1, radius = ~BufferSize, color = ~palette(MOS11), opacity = 1, fillOpacity = 0.5, popup = ~name_site)

amp_artificial <- amp_artificial %>% addLegend(position = "bottomright", pal = palette, values = ~MOS11, title = "MOS11", opacity = 1)

amp_artificial
```

```{r}
data_join <- Oiseaux %>% left_join(y = Land_cartoISea_2000, by = c("Code_Maille" = "ID"))

res <- data_join %>%
  group_by(MOS11, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res, aes(x = MOS11, y = Nb_espece, color = Year)) +
  geom_point() +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation")
```



On a quasiment les mêmes graphs que pour les ACP donc on en déduit les mêmes résultats pour toutes les tailles de buffer. 

## Mais maintenant si on prend le BufferSize comme une donnée quelconque, est-ce que ce dernier à un impact sur le nombre d'espèces qu'on observe ?

```{r}
data_join <- Oiseaux %>% left_join(y = Land_cartoISea, by = c("Code_Maille" = "ID"))
data_join
```

```{r}
variables <- data_join %>%
  select(MOS11, BufferSize, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

```{r}
# Nombre total pour chaque modalité Milieu_favori
tot_Milieu_favori <- Traits %>%
  group_by(Milieu_favori) %>%
  summarise(Total = n())

tot_Milieu_favori
```

```{r}
# Nombre d'oiseaux au total
Oiseaux_Tot <- sum(Oiseaux$Denombrement_min)
```

## Formules de diversité

i <- espece
j <- site

### Formule 1
```{r}
proportion <- function(data, year) {
  data <- data[data$Year == year,]
  x_ij <- aggregate(data$Denombrement_min, by = list(Code_Maille = data$Code_Maille, Nom_Latin = data$Nom_Latin), FUN = sum)
  x_tot_j <- aggregate(data$Denombrement_min, by = list(Code_Maille = data$Code_Maille), FUN = sum)
  x_ij_merge <- merge(x_ij, x_tot_j, by = "Code_Maille")
  p_ij <- x_ij_merge$x.x / x_ij_merge$x.y
  
  proportions <- data.frame(Code_Maille = x_ij_merge$Code_Maille,
                            Nom_Latin = x_ij_merge$Nom_Latin,
                            Proportion = p_ij)
  
  return(proportions)
}
```

### Formule 2
H_j = entropie (somme par site)
```{r}
exp_shannon <- function(proportions) {
  H_j <- numeric(length(unique(proportions$Code_Maille)))
  
  for (j in 1:length(unique(proportions$Code_Maille))) {
    p_ij_site <- proportions$Proportion[proportions$Code_Maille == unique(proportions$Code_Maille)[j] & proportions$Proportion > 0]
    H_j[j] <- -sum(p_ij_site * log(p_ij_site))
  }
  
  D_2 <- data.frame(Code_Maille = unique(proportions$Code_Maille), D_2 = exp(H_j))
  
  return(D_2)
}
```

### Formule 3

1 divisé par la proba que deux individus qu'on prend dans un ehcantillon soient de la meme espece, donc plus la proba augmente, plus D_3 va diminuer car la proba est au dénominateur

```{r}
proba_simpson <- function(proportions) {
  D_3 <- numeric(length(unique(proportions$Code_Maille)))
  
  for (j in 1:length(unique(proportions$Code_Maille))) {
    p_ij_site <- proportions$Proportion[proportions$Code_Maille == unique(proportions$Code_Maille)[j] & proportions$Proportion > 0]
    D_3[j] <- 1 / sum(p_ij_site^2)
  }
  
  D_3_df <- data.frame(Code_Maille = unique(proportions$Code_Maille), D_3 = D_3)
  
  return(D_3_df)
}
```

## Tests

### Test fictif
```{r}
x <- c(0, 1, 1, 2, 5)
y <- c(2021, 2021, 2021, 2021, 2021)
fictif <- data.frame(Denombrement_min = x, Code_Maille = c('2','2','2','4','4'), Nom_Latin = c('a','b','c','d','e'), Year = y)
proportions_fictif <- proportion(fictif, 2021)
D_2_fictif <- exp_shannon(proportions_fictif)
D_3_fictif <- proba_simpson(proportions_fictif)

proportions_fictif
D_2_fictif
D_3_fictif
```

### Test sur tous les oiseaux
```{r}
proportions_oiseaux <- proportion(Oiseaux, 2018)
D_2_oiseaux <- exp_shannon(proportions_oiseaux)
D_3_oiseaux <- proba_simpson(proportions_oiseaux)
proportions_oiseaux
D_2_oiseaux
D_3_oiseaux
```

### Test sur une espèce d'oiseaux
```{r}
especes_choisies <- as.data.frame(Oiseaux[Oiseaux$Nom_Latin %in% c('Erithacus rubecula', 'Passer domesticus'), ])
proportions_ER <- proportion(especes_choisies, 2022)
D_2_ER <- exp_shannon(proportions_ER)
D_3_ER <- proba_simpson(proportions_ER)
proportions_ER
D_2_ER
D_3_ER
```

Pour les graphes suivants, nous choisissons de représenter nos valeurs seulement en fonction des sites présents sur toutes les années.

## Graphe : Indice de Shannon
```{r}
resultats_D_2_v1 <- list()
annees <- c(2018, 2019, 2022, 2023)
for (annee in annees) {
  proportions_oiseaux <- proportion(Oiseaux, annee)
  D_2_oiseaux <- exp_shannon(proportions_oiseaux)
  moyenne_D_2 <- mean(D_2_oiseaux$D_2)
  resultats_D_2_v1[[as.character(annee)]] <- D_2_oiseaux
}

code_maille_presentes <- Reduce(intersect, lapply(resultats_D_2_v1, function(x) x$Code_Maille))
resultats_filtres <- lapply(resultats_D_2_v1, function(x) x[x$Code_Maille %in% code_maille_presentes, ])
resultats_moyenne <- lapply(resultats_filtres, function(x) mean(x$D_2))
resultats_df <- data.frame(Année = as.integer(names(resultats_moyenne)), Moyenne_D_2 = unlist(resultats_moyenne))

ggplot(data = resultats_df, aes(x = Année, y = Moyenne_D_2)) +
  geom_line(color = "pink", size = 1.5) +
  geom_point() +
  labs(title = "Évolution de la moyenne de D_2_oiseaux par année",
       x = "Année",
       y = "Moyenne de D_2_oiseaux") +
  theme_minimal()
```
On remarque que, entre 2018, 2019 et 2022, l'exponentielle de l'indice de Shannon diminue varie entre 20.20 et 20.75 en moyenne, ce qui est très léger. De 2022-2023, l'exponentielle de l'indice de Shannon diminue d'environ 1.0 en moyenne, ce qui reste aussi assez léger. Finalement, celui-ci reste assez constant au fil des années.

```{r}
resultats_D_2_v2 <- list()
annees <- c(2018, 2019, 2022, 2023)
for (annee in annees) {
  proportions_oiseaux <- proportion(Oiseaux, annee)
  D_2_oiseaux <- exp_shannon(proportions_oiseaux)
  D_2_oiseaux$Année <- as.integer(annee)
  resultats_D_2_v2[[as.character(annee)]] <- D_2_oiseaux
}

D_2_annees <- do.call(rbind, resultats_D_2_v2)
D_2_annees$Année <- factor(D_2_annees$Année)

#filtrer les sites présents sur toutes les années
nombre_annees_par_site <- table(D_2_annees$Code_Maille)
nombre_total_annees <- length(unique(D_2_annees$Année))
sites_present_toutes_annees <- names(nombre_annees_par_site[nombre_annees_par_site == nombre_total_annees])
D_2_annees_filtre <- D_2_annees[D_2_annees$Code_Maille %in% sites_present_toutes_annees,]

ggplot(data = D_2_annees_filtre, aes(x = Année, y = D_2, group = Code_Maille, color = factor(Code_Maille))) +
  geom_line() +
  labs(title = "Évolution de D_2_oiseaux par année",
       x = "Année",
       y = "D_2") +
  theme_minimal() +
  theme(legend.position = "none")

D_2_annees_filtre <- D_2_annees[D_2_annees$Code_Maille %in% sites_present_toutes_annees,]

ggplot(data = D_2_annees_filtre, aes(x = D_2, fill = factor(Année))) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution de l'indice D_2 par année",
       x = "D_2",
       y = "Densité") +
  scale_fill_brewer(palette = "Set3") + 
  theme_minimal() +
  facet_wrap(~ Année)
```

## Graphe : Indice de Simpson
```{r}
resultats_D_3 <- list()
annees <- c(2018, 2019, 2022, 2023)
for (annee in annees) {
  proportions_oiseaux <- proportion(Oiseaux, annee)
  D_3_oiseaux <- proba_simpson(proportions_oiseaux)
  D_3_oiseaux$Année <- as.integer(annee)
  resultats_D_3[[as.character(annee)]] <- D_3_oiseaux
}

D_3_annees <- do.call(rbind, resultats_D_3)
D_3_annees$Année <- factor(D_3_annees$Année)

#filtrer les sites présents sur toutes les années
nombre_annees_par_site <- table(D_3_annees$Code_Maille)
nombre_total_annees <- length(unique(D_3_annees$Année))
sites_present_toutes_annees <- names(nombre_annees_par_site[nombre_annees_par_site == nombre_total_annees])
D_3_annees_filtre <- D_3_annees[D_3_annees$Code_Maille %in% sites_present_toutes_annees,]

ggplot(data = D_3_annees_filtre, aes(x = Année, y = D_3, group = Code_Maille, color = factor(Code_Maille))) +
  geom_line() +
  labs(title = "Évolution de D_3 par sites au cours des années",
       x = "Année",
       y = "D_3") +
  theme_minimal() +
  theme(legend.position = "none")


D_3_annees_filtre <- D_3_annees[D_3_annees$Code_Maille %in% sites_present_toutes_annees,]

ggplot(data = D_3_annees_filtre, aes(x = D_3, fill = factor(Année))) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution de l'indice D_3 par année",
       x = "D_3",
       y = "Densité") +
  scale_fill_brewer(palette = "Set3") + 
  theme_minimal() +
  facet_wrap(~ Année)
```

La distribution de l'indice de D3 (tous les sites qui revienent chque année). On peut le laisser et dire qu'on remarque que la distribution ne change pas au cours des années ou très très peu. 

Graph "Nombre d'oiseaux par température"
```{r}
donnees_agregate <- aggregate(Nom_Latin ~ Temperature, data = Oiseaux, FUN = function(x) length(unique(x)))

plot(donnees_agregate$Temperature, donnees_agregate$Nom_Latin, type = "b", 
     xlab = "Température (°C)", ylab = "Nombre d'oiseaux",
     main = "Nombre d'espèces par température",
     col = "blue", pch = 19)
```

Biodiversité -> diversité d'espèces
Il faut se concentrer sur la diversité d'espèces et pas sur les nombres donc le dernier graph
Corrélation par point entre le nombre d'espèce et le % d'artificialisation -> chaque point correspond à une espèce
Le nombre d'oiseaux c'est pas de la biodiversité, c'est seulement le nombre d'oiseaux comptés -> la biodiversité c'est le nombre d'espèces
Si on prend le comptage du nombre d'oiseaux, ce dernier augmente quand la surface artificialisée augmente. Il faudrait différencier les années pour les étudier une par une et voir pourquoi il y a des différences entre ces années ? % d'artificialisation ou température, vent, nuage (données ambiantes)
Le faire année par année : 2018-2023 ça va changer ?? si ça change ca veut dire qu'on a une autre variable explicative on ira chercher les données ambiantes -> faire des comptages des températures en fonction des espèces
-> remplacer en abscisse la surface artificialisée par la température par exemple 
Une ACP : essayer de voir si vraiment la variabilité du nombre d'espèces est expliqué par l'artificialisation ou si elle peut être expliquée par d'autres variables ambiantes.
Calculer simpson pour les 4 années
Richesse/shannon : nombre d'espèces présentes, calculer en fonction du mos/taille du buffer à 500 -> quelle est l'occupation du sol ou la diversité/richesse est la plus importante ? Normalement c'est dans les forêts qu'on aura une plus grande diversité comparée aux surfaces artificialisées. 


```{r}
data_join_1 <- Oiseaux %>% 
  left_join(Traits, by = c("Nom_Latin" = "Nom.latin"))

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join_2 <- data_join_1 %>%
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID"))

donnees_agregate2 <- aggregate(Nom_Latin ~ MOS11 + Year + Régime.alimentaire, data = data_join_2, FUN = function(x) length(unique(x)))

donnees_agregate2$Year <- factor(donnees_agregate2$Year)

ggplot(data = donnees_agregate2, aes(x = MOS11, y = Nom_Latin, color = Régime.alimentaire)) +
  geom_point(color = "grey") +
  geom_smooth(method = "auto", se = TRUE, color = "black") + 
  geom_smooth(method = "lm", se = FALSE, aes(group = Régime.alimentaire), linetype = "solid") +
  xlab("Surfaces artificialisées en % (MOS11)") +
  ylab("Nombre d'espèces d'oiseaux") + 
  ggtitle("Diversité en fonction du nombre d'espèces d'oiseaux et le degré d'artificialisation") +
  scale_color_manual(name = "Régime.alimentaire", 
                     values = c("Carnivore" = "red", "Mixte" = "blue", "Végétarien" = "orange")) +
  theme_minimal()
```
## Graphe "Diversité en fonction du nombre d'oiseaux et le degré d'artificialisation"
```{r}
data_join_1 <- Oiseaux %>% 
  left_join(Traits, by = c("Nom_Latin" = "Nom.latin"))

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join_2 <- data_join_1 %>%
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID"))

donnees_agregate2 <- aggregate(Nom_Latin ~ MOS11 + Year + Milieu_favori, data = data_join_2, FUN = function(x) length(unique(x)))

donnees_agregate2$Year <- factor(donnees_agregate2$Year)

ggplot(data = donnees_agregate2, aes(x = MOS11, y = Nom_Latin, color = Milieu_favori)) +
  geom_point(color = "grey") +
  geom_smooth(method = "auto", se = TRUE, color = "black") + 
  geom_smooth(method = "lm", se = FALSE, aes(group = Milieu_favori), linetype = "solid") +
  xlab("Surfaces artificialisées en % (MOS11)") +
  ylab("Nombre d'espèces d'oiseaux") + 
  ggtitle("Diversité en fonction du nombre d'espèces d'oiseaux et le degré d'artificialisation") +
  scale_color_manual(name = "Milieu_favori", 
                     values = c("Agricole" = "red", "Forêt" = "blue", "Bâti" = "orange", "Généraliste" = "pink", "Zone humide" = "green")) +
  theme_minimal()
```

## Histogramme du nombre d'oiseaux dont l'espèce est la plus présente par température
```{r}
result <- Oiseaux %>%
  group_by(Temperature, Nom_Latin) %>%
  summarise(Total = sum(Denombrement_min)) %>%
  slice(which.max(Total)) 

ggplot(result, aes(x = Temperature, y = Total, fill = Nom_Latin)) +
  geom_bar(stat = "identity") +
  labs(title = "Nombre d'oiseaux dont l'espèce est la plus présente par température",
       x = "Température (°C)",
       y = "Nombre total d'oiseaux de l'espèce la plus présente",
       fill = "Nom Latin") +
  theme_minimal()
```
"Le moineau domestique est un oiseau sédentaire. Cela signifie qu'il ne migre pas et vit toujours au même endroit. C'est donc un des rares oiseaux que tu peux encore observer en automne et en hiver."
C'est pourquoi le "Passer domesticus" est présent tout le long de l'année en grand nombre.

## Histogramme du nombre d'oiseaux dont l'espèce est la plus présente par intensité du vent
```{r}
result2 <- Oiseaux %>%
  group_by(Vent, Nom_Latin) %>%
  summarise(Total = sum(Denombrement_min)) %>%
  slice(which.max(Total)) 

ggplot(result2, aes(x = Vent, y = Total, fill = Nom_Latin)) +
  geom_bar(stat = "identity") +
  labs(title = "Nombre d'oiseaux dont l'espèce est la plus présente par intensité du vent",
       x = "Intensité du vent",
       y = "Nombre total d'oiseaux de l'espèce la plus présente",
       fill = "Nom Latin") +
  theme_minimal()
```

## Histogramme du nombre d'oiseaux dont l'espèce est la plus présente par couverture nuageuse
```{r}
result3 <- Oiseaux %>%
  group_by(Couvert_Nuageux, Nom_Latin) %>%
  summarise(Total = sum(Denombrement_min)) %>%
  slice(which.max(Total)) 

ggplot(result3, aes(x = Couvert_Nuageux, y = Total, fill = Nom_Latin)) +
  geom_bar(stat = "identity") +
  labs(title = "Nombre d'oiseaux dont l'espèce est la plus présente par couverture nuageuse",
       x = "Couverture nuageuse",
       y = "Nombre total d'oiseaux de l'espèce la plus présente",
       fill = "Nom Latin") +
  theme_minimal()
```

## 4. Questions

2) la forme de la relation est-elle similaire si on considère non plus l’imperméabilisation du sol mais plutôt la distance au centre ville, sachant que ces deux métriques sont corrélées? On pourra considérer Pey-Berland le centre ville et utiliser le package sf.

Nous avons pris comme point "centre-ville" le point "Bordeaux-A" car nous n'avons pas le point "Pey-Berland" dans nos données.
```{r}
centres_villes <- Sites %>% 
                        left_join(y = Land_cartoISea_500, 
                                  by = c("code_site" = "ID"))

centres_villes <- centres_villes %>% 
                        left_join(y = Oiseaux, 
                                  by = c("code_site" = "Code_Maille"))

centre_ville_interet <- centres_villes[centres_villes$name_site == "Bordeaux-A", ]

centre_ville_latitude <- centres_villes$X.y[centres_villes$name_site == "Bordeaux-A"]
centre_ville_longitude <- centres_villes$Y[centres_villes$name_site == "Bordeaux-A"]

centre_ville_latitude <- centre_ville_latitude[1]
centre_ville_longitude <- centre_ville_longitude[1]

centres_villes$Y <- as.numeric(centres_villes$Y)
centre_ville_latitude <- as.numeric(centre_ville_latitude)

centres_villes$distance_centre_ville <- sqrt((centres_villes$X.y - centre_ville_longitude)^2 + (centres_villes$Y - centre_ville_latitude)^2)

donnees_agregate_distance <- aggregate(Nom_Latin ~ distance_centre_ville, data = centres_villes, FUN = function(x) length(unique(x)))

ggplot(data = donnees_agregate_distance, aes(x = distance_centre_ville, y = Nom_Latin)) +
  geom_point(color = "grey") +
  geom_smooth(method = "auto", se = FALSE, color = "black") + 
  xlab("Distance par rapport au centre-ville") +
  ylab("Nombre d'espèces d'oiseaux") + 
  ggtitle("Nombre d'espèces d'oiseaux en fonction de la distance par rapport au centre-ville") +
  theme_minimal()
```

## Carte points en fonction du nombre des oiseaux
```{r}
data_join_1 <- Oiseaux %>% 
  left_join(Traits, by = c("Nom_Latin" = "Nom.latin"))

data_join_2 <- data_join_1 %>%
  right_join(Sites, by = c("Code_Maille" = "code_site"))

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join_2 <- data_join_2 %>%
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID"))

data_join_2$Y <- as.numeric(data_join_2$Y)
data_join_2$X.y <- as.numeric(data_join_2$X.y)

donnees_agregate <- aggregate(Nom_Latin ~ Nom_lieu + X.y + Y + BufferSize + name_site, data = data_join_2, FUN = function(x) length(unique(x)))

palette <- colorNumeric(palette = "magma", domain = donnees_agregate$Nom_Latin,reverse = TRUE)

amp_oiseaux <- leaflet(data = donnees_agregate) %>% 
  addTiles() %>%
  addCircles(~X.y, ~Y, weight = 1, radius = ~BufferSize, color = ~palette(Nom_Latin), opacity = 1, fillOpacity = 0.5, popup = ~name_site)

amp_oiseaux <- amp_oiseaux %>% addLegend(position = "bottomright", pal = palette, values = ~Nom_Latin, title = "Nombre d'espèces", opacity = 1)
amp_oiseaux
```
