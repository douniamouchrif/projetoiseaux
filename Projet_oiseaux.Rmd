---
title: "Projet"
output: 
  html_document:
    code_folding: hide
    code_download: true
    theme: united
    highlight: tango
    df_print: paged
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
date: "`r format(Sys.Date(), '%d %B, %Y')`"
author:
   - name: ""
     affiliation: "Université de Bordeaux - CMI ISI M1 - UE : Projet de statistique pour données environnementales 2024"
---
title: "Projet oiseaux"
output: html_document
date: "2024-02-19"
---

```{r}
library(dplyr)
library(sp)
library(leaflet)
library(ggplot2)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
Sites <- read.csv("Data/BiodiverCite_sites.csv", header = TRUE, sep = ";")
Land_cartoISea <- read.csv("Data/LandUsePer_BM_2023_cartoISea.csv", header = TRUE)
Oiseaux <- read.csv("Data/Oiseaux_up_to_2023.csv", header = TRUE, sep = "\t")
Traits <- read.csv("Data/traits-statut-IUCN-biodivercite.csv", header = TRUE, sep = ",")
```

```{r}
head(Sites)
```
```{r}
nrow(Land_cartoISea)
```
Pour chaque point on a 5 tailles de buffer --> 53x5

```{r}
head(Land_cartoISea)
```

```{r}
head(Oiseaux)
```
```{r}
head(Traits)
```



```{r}
Oiseaux$Nom_Latin <- sapply(strsplit(Oiseaux$Nom_Taxon_Cite, "\\|"), function(x) trimws(x[1]))
Oiseaux$Year <- sapply(strsplit(Oiseaux$Date, "\\-"), function(x) trimws(x[1]))
print(Oiseaux)
```

```{r}
#renommer la 4éme colonne
names(Traits)[4] = "Milieu_favori"
```

```{r}
# Nombre total pour chaque modalité Milieu_favori
tot_Milieu_favori <- Traits %>%
  group_by(Milieu_favori) %>%
  summarise(Total = n())

tot_Milieu_favori
```

```{r}
# Join tables Oiseaux et Traits
data_join <- Oiseaux %>% left_join(y = Traits, 
                                  by = c("Nom_Latin" = "Nom.latin"))
```

```{r}
# Nombre d'oiseaux au total
Oiseaux_Tot <- sum(Oiseaux$Denombrement_min)
```

```{r}
donnees_agregate <- aggregate(Denombrement_min ~ Temperature, data = Oiseaux, FUN = sum)

# Tracer le graphique
plot(donnees_agregate$Temperature, donnees_agregate$Denombrement_min, type = "b", 
     xlab = "Température (°C)", ylab = "Nombre d'oiseaux",
     main = "Nombre d'oiseaux par température",
     col = "blue", pch = 19)

```


```{r}
#on commence avec un buffer size à 500
Land_cartoISea_500 <- Land_cartoISea%>% filter(BufferSize == 500)

###on join les df Land_cartoISea_500 et Oiseaux 
data_join <- Oiseaux %>% left_join(y = Land_cartoISea_500, 
                                  by = c("Code_Maille" = "ID"))

############################ Nombre Oiseaux au total
donnees_agregate2 <- aggregate(data_join$Denombrement_min, by = list(MOS11 = data_join$MOS11,Year = data_join$Year), FUN = sum)
donnees_agregate2 <- transform(donnees_agregate2, nb_oiseaux = x)
qplot(x = MOS11, y = nb_oiseaux, data = donnees_agregate2, color = Year, xlab = "Surfaces artificialisées en % (MOS11)", ylab = "Nombre d'oiseaux", main = "Nombre d'oiseaux en fonction du pourcentage d'artificialisation") + geom_smooth(method = "auto", se = TRUE, color = "black") 

############################ Nombre Oiseaux par espèce
donnees_agregate3 <- aggregate(data_join$Denombrement_min, by = list(MOS11 = data_join$MOS11,Year = data_join$Year, Nom_Latin = data_join$Nom_Latin), FUN = sum)
donnees_agregate3 <- transform(donnees_agregate3, nb_oiseaux = x)
qplot(x = MOS11, y = nb_oiseaux, data = donnees_agregate3, color = Year, xlab = "Surfaces artificialisées en % (MOS11)", ylab = "Nombre d'oiseaux", main = "Nombre d'oiseaux par espèces en fonction du pourcentage d'artificialisation") + geom_smooth(method = "auto", se = TRUE, color = "black") 

############################# Nombre d'espèces 
res <- data_join %>%
  group_by(MOS11,Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
qplot(x = MOS11, y = Nb_espece, data = res, color = Year, xlab = "Surfaces artificialisées en % (MOS11)", ylab = "Nombre d'espèces", main = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation") + geom_smooth(method = "auto", se = TRUE, color = "black") 

##################
#on voit qu'un % d'artificialisation des surfaces elevé a tendence à faire diminuer la diversité des espèces mais pas le nombre d'oiseaux au total ou par espèce


#on peut comperer avec les autres types de surface (genre les trucs plus nature) ? 
#on peut aussi voir l'évolution du nombre d'espèces ou d'oiseau au cours des années 
```
Biodiversité -> diversité d'espèces
Il faut se concentrer sur la diversité d'espèces et pas sur les nombres donc le dernier graph
Corrélation par point entre le nombre d'espèce et le % d'artificialisation -> chaque point correspond à une espèce
Le nombre d'oiseaux c'est pas de la biodiversité, c'est seulement le nombre d'oiseaux comptés -> la biodiversité c'est le nombre d'espèces
Si on prend le comptage du nombre d'oiseaux, ce dernier augmente quand la surface artificialisée augmente. Il faudrait différencier les années pour les étudier une par une et voir pourquoi il y a des différences entre ces années ? % d'artificialisation ou température, vent, nuage (données ambiantes)
Le faire année par année : 2018-2023 ça va changer ?? si ça change ca veut dire qu'on a une autre variable explicative on ira chercher les données ambiantes -> faire des comptages des températures en fonction des espèces
-> remplacer en abscisse la surface artificialisée par la température par exemple 
Une ACP : essayer de voir si vraiment la variabilité du nombre d'espèces est expliqué par l'artificialisation ou si elle peut être expliquée par d'autres variables ambiantes.
Calculer simpson pour les 4 années
Richesse/shannon : nombre d'espèces présentes, calculer en fonction du mos/taille du buffer à 500 -> quelle est l'occupation du sol ou la diversité/richesse est la plus importante ? Normalement c'est dans les forêts qu'on aura une plus grande diversité comparée aux surfaces artificialisées. 


```{r}
freq <- table(Oiseaux$Nom_Latin)


library(ggplot2)
X <- runif(100)
# La moyenne n'est pas définie à r=0, décalage de 10^-8
r <- seq(-5, 10, .1) + 1E-8
# Préparation des données
df <- data.frame(freq, Moyenne = sapply(freq, function(freq) (mean(X^freq))^(1/freq))) 
ggplot(df, aes(x = freq, y = Moyenne)) +
  geom_line()
```

## Histogramme du nombre d'oiseaux dont l'espèce est la plus présente par température
```{r}
result <- Oiseaux %>%
  group_by(Temperature, Nom_Latin) %>%
  summarise(Total = sum(Denombrement_min)) %>%
  slice(which.max(Total)) 

ggplot(result, aes(x = Temperature, y = Total, fill = Nom_Latin)) +
  geom_bar(stat = "identity") +
  labs(title = "Nombre d'oiseaux dont l'espèce est la plus présente par température",
       x = "Température (°C)",
       y = "Nombre total d'oiseaux de l'espèce la plus présente",
       fill = "Nom Latin") +
  theme_minimal()
```
"Le moineau domestique est un oiseau sédentaire. Cela signifie qu'il ne migre pas et vit toujours au même endroit. C'est donc un des rares oiseaux que tu peux encore observer en automne et en hiver."
C'est pourquoi le "Passer domesticus" est présent tout le long de l'année en grand nombre.

## Histogramme du nombre d'oiseaux dont l'espèce est la plus présente par intensité du vent
```{r}
result2 <- Oiseaux %>%
  group_by(Vent, Nom_Latin) %>%
  summarise(Total = sum(Denombrement_min)) %>%
  slice(which.max(Total)) 

ggplot(result2, aes(x = Vent, y = Total, fill = Nom_Latin)) +
  geom_bar(stat = "identity") +
  labs(title = "Nombre d'oiseaux dont l'espèce est la plus présente par intensité du vent",
       x = "Intensité du vent",
       y = "Nombre total d'oiseaux de l'espèce la plus présente",
       fill = "Nom Latin") +
  theme_minimal()
```

## Histogramme du nombre d'oiseaux dont l'espèce est la plus présente par couverture nuageuse
```{r}
result3 <- Oiseaux %>%
  group_by(Couvert_Nuageux, Nom_Latin) %>%
  summarise(Total = sum(Denombrement_min)) %>%
  slice(which.max(Total)) 

ggplot(result3, aes(x = Couvert_Nuageux, y = Total, fill = Nom_Latin)) +
  geom_bar(stat = "identity") +
  labs(title = "Nombre d'oiseaux dont l'espèce est la plus présente par couverture nuageuse",
       x = "Couverture nuageuse",
       y = "Nombre total d'oiseaux de l'espèce la plus présente",
       fill = "Nom Latin") +
  theme_minimal()
```

## Carte points 
```{r}
lambert_data <- data.frame(X = Land_cartoISea$X, Y = Land_cartoISea$Y)
coordinates(lambert_data) <- c("X", "Y")

proj4string(lambert_data) <- CRS("+proj=lcc +lat_1=48 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +units=m +no_defs")

wgs84 <- CRS("+proj=longlat +datum=WGS84")

lambert_to_wgs84 <- spTransform(lambert_data, wgs84)

countryPolygons.df <- as.data.frame(lambert_to_wgs84)
```

```{r}
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x1"] <- "X"
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x2"] <- "Y"
Land_cartoISea <- select(Land_cartoISea, -X, -Y)
Land_cartoISea <- cbind(Land_cartoISea, countryPolygons.df)
Land_cartoISea_500 <- subset(Land_cartoISea, BufferSize == 500)
```

```{r}
table_jointe_tbl <- Sites %>% 
                        left_join(y = Land_cartoISea_500, 
                                  by = c("code_site" = "ID"))
table_jointe_tbl
```

```{r}
palette <- colorNumeric(palette = "viridis", domain = table_jointe_tbl$MOS11)

amp_artificial <- leaflet(data = table_jointe_tbl) %>% 
  addTiles() %>%
  addCircles(~X.y, ~Y, weight = 1, radius = ~BufferSize, color = ~palette(MOS11), opacity = 1, fillOpacity = 0.5, popup = ~name_site)

amp_artificial <- amp_artificial %>% addLegend(position = "bottomright", pal = palette, values = ~MOS11, title = "MOS11", opacity = 1)

amp_artificial
```
On constate que les sites situés en dehors de l'agglomération urbaine ont un taux d'artificialisation moins important que les sites localisés dans la ville de Bordeaux, comme par exemple "Talence-B" avec un taux d'artificialisation proche de 0.6.