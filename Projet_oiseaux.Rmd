---
title: "Projet"
output: 
  html_document:
    code_folding: hide
    code_download: true
    theme: united
    highlight: tango
    df_print: paged
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: false
date: "`r format(Sys.Date(), '%d %B, %Y')`"
author:
   - name: ""
     affiliation: "Université de Bordeaux - CMI ISI M1 - UE : Projet de statistique pour données environnementales 2024"
---
title: "Projet oiseaux"
output: html_document
date: "2024-02-19"
---
# Imports nécessaires pour le fonctionnement de notre projet
```{r}
library(dplyr)
library(sp)
library(leaflet)
library(leaflet.extras)
library(leaflet.minicharts)
library(ggplot2)
library(FactoMineR)
library(tidyr)
library(gridExtra)
library(patchwork)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Présentation des données
```{r}
Sites <- read.csv("Data/BiodiverCite_sites.csv", header = TRUE, sep = ";")
Land_cartoISea <- read.csv("Data/LandUsePer_BM_2023_cartoISea.csv", header = TRUE)
Oiseaux <- read.csv("Data/Oiseaux_up_to_2023.csv", header = TRUE, sep = "\t")
Traits <- read.csv("Data/traits-statut-IUCN-biodivercite.csv", header = TRUE, sep = ",")
```

```{r}
head(Sites)
```

```{r}
nrow(Land_cartoISea)
```

```{r}
head(Land_cartoISea)
```

```{r}
head(Oiseaux)
```

```{r}
head(Traits)
```

```{r}
Oiseaux$Nom_Latin <- sapply(strsplit(Oiseaux$Nom_Taxon_Cite, "\\|"), function(x) trimws(x[1]))
Oiseaux$Year <- sapply(strsplit(Oiseaux$Date, "\\-"), function(x) trimws(x[1]))
print(Oiseaux)
```

```{r}
#renommer la 4éme colonne
names(Traits)[4] = "Milieu_favori"
```

```{r}
# Définir les années d'intérêt
years <- c(2018, 2019, 2022, 2023)
```


# Statistiques descriptives pour prendre connaissance des données

```{r}
top3_species <- Oiseaux %>%
  group_by(Year, Nom_Latin) %>%
  summarise(Total = sum(Denombrement_min)) %>%
  arrange(Year, desc(Total)) %>%
  group_by(Year) %>%
  slice(1:3)

ggplot(top3_species, aes(x = factor(Year), y = Total, fill = Nom_Latin)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Top 3 des espèces d'oiseaux les plus présentes par année",
       x = "Année",
       y = "Nombre total d'oiseaux",
       fill = "Nom Latin") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~Year, scales = "free_x")
```

```{r}
Traits$Milieu_favori[Traits$Nom.latin == 'Columba palumbus']
Traits$Milieu_favori[Traits$Nom.latin == 'Parus major']
Traits$Milieu_favori[Traits$Nom.latin == 'Passer domesticus']
Traits$Milieu_favori[Traits$Nom.latin == 'Sturnus vulgaris']
Traits$Milieu_favori[Traits$Nom.latin == 'Sylvia atricapilla']
Traits$Milieu_favori[Traits$Nom.latin == 'Turdus merula']
```

```{r}
Traits$Régime.alimentaire[Traits$Nom.latin == 'Columba palumbus']
Traits$Régime.alimentaire[Traits$Nom.latin == 'Parus major']
Traits$Régime.alimentaire[Traits$Nom.latin == 'Passer domesticus']
Traits$Régime.alimentaire[Traits$Nom.latin == 'Sturnus vulgaris']
Traits$Régime.alimentaire[Traits$Nom.latin == 'Sylvia atricapilla']
Traits$Régime.alimentaire[Traits$Nom.latin == 'Turdus merula']
```

```{r}
Traits$Nidification[Traits$Nom.latin == 'Columba palumbus']
Traits$Nidification[Traits$Nom.latin == 'Parus major']
Traits$Nidification[Traits$Nom.latin == 'Passer domesticus']
Traits$Nidification[Traits$Nom.latin == 'Sturnus vulgaris']
Traits$Nidification[Traits$Nom.latin == 'Sylvia atricapilla']
Traits$Nidification[Traits$Nom.latin == 'Turdus merula']
```

```{r}
Traits$Statut.de.protection[Traits$Nom.latin == 'Columba palumbus']
Traits$Statut.de.protection[Traits$Nom.latin == 'Parus major']
Traits$Statut.de.protection[Traits$Nom.latin == 'Passer domesticus']
Traits$Statut.de.protection[Traits$Nom.latin == 'Sturnus vulgaris']
Traits$Statut.de.protection[Traits$Nom.latin == 'Sylvia atricapilla']
Traits$Statut.de.protection[Traits$Nom.latin == 'Turdus merula']
```
```{r}
donnees_temp <- aggregate(Nom_Latin ~ Temperature, data = Oiseaux, FUN = function(x) length(unique(x)))

plot(donnees_temp$Temperature, donnees_temp$Nom_Latin, type = "b", 
     xlab = "Température (°C)", ylab = "Nombre d'espèces",
     main = "Nombre d'espèces en fonction de la température",
     col = "blue", pch = 19)
```

```{r}
donnees_vent <- aggregate(Nom_Latin ~ Vent, data = Oiseaux, FUN = function(x) length(unique(x)))
donnees_vent$Vent_num <- as.numeric(gsub(" .*", "", donnees_vent$Vent))

plot(donnees_vent$Vent_num, donnees_vent$Nom_Latin, type = "b", 
     xlab = "Intensité du vent", ylab = "Nombre d'espèces",
     main = "Nombre d'espèces en fonction de l'intensité du vent",
     col = "blue", pch = 19)
```

## Histogramme du nombre d'oiseaux dont l'espèce est la plus présente en fonction de la température et par année
```{r}
temp_species <- function(year) {
  temp_data <- Oiseaux %>%
    filter(Year == year) %>%
    group_by(Temperature, Nom_Latin) %>%
    summarise(Total = sum(Denombrement_min)) %>%
    slice(which.max(Total))
  
  ggplot(temp_data, aes(x = Temperature, y = Total, fill = Nom_Latin)) +
    geom_bar(stat = "identity") +
    labs(title = paste(year),
         x = "Température (°C)",
         y = "Nombre d'oiseaux",
         fill = "Nom Latin") +
    theme_minimal()
}

plot_1 <- lapply(years, temp_species)
grid.arrange(grobs = plot_1, ncol = 2)
```
## Histogramme du nombre d'oiseaux dont l'espèce est la plus présente en fonction de l'intensité du vent
```{r}
vent_species <- function(year) {
  vent_data <- Oiseaux %>%
    filter(Year == year) %>%
    group_by(Vent, Nom_Latin) %>%
    summarise(Total = sum(Denombrement_min)) %>%
    slice(which.max(Total))
  
  ggplot(vent_data, aes(x = Vent, y = Total, fill = Nom_Latin)) +
    geom_bar(stat = "identity") +
    labs(title = paste(year),
         x = "Intensité du vent",
         y = "Nombre d'oiseaux",
         fill = "Nom Latin") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 8))
}

plot_2 <- lapply(years, vent_species)
grid.arrange(grobs = plot_2, ncol = 2)
```
## Histogramme du nombre d'oiseaux dont l'espèce est la plus présente en fonction de la couverture nuageuse
```{r}
nuage_species <- function(year) {
  nuage_data <- Oiseaux %>%
    filter(Year == year) %>%
    group_by(Couvert_Nuageux, Nom_Latin) %>%
    summarise(Total = sum(Denombrement_min)) %>%
    slice(which.max(Total))
  
  ggplot(nuage_data, aes(x = Couvert_Nuageux, y = Total, fill = Nom_Latin)) +
    geom_bar(stat = "identity") +
    labs(title = paste(year),
         x = "Couverture nuageuse",
         y = "Nombre d'oiseaux",
         fill = "Nom Latin") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 8))
}

plot_3 <- lapply(years, nuage_species)
grid.arrange(grobs = plot_3, ncol = 2)
```
```{r}
boxplot_oiseaux <- Oiseaux %>%
  group_by(Year, Nom_Latin) %>%
  summarise(Total_Birds = sum(Denombrement_min))

ggplot(boxplot_oiseaux, aes(x = factor(Year), y = Total_Birds)) +
  geom_boxplot() +
  labs(title = "Distribution du nombre d'oiseaux par espèce au fil des années",
       x = "Année",
       y = "Nombre total d'oiseaux") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
# Quelle est la forme de la relation biodiversité vs imperméabilisation du sol?

## carte ...
```{r}
lambert_data <- data.frame(X = Land_cartoISea$X, Y = Land_cartoISea$Y)
coordinates(lambert_data) <- c("X", "Y")

proj4string(lambert_data) <- CRS("+proj=lcc +lat_1=48 +lat_2=44 +lat_0=46.5 +lon_0=3 +x_0=700000 +y_0=6600000 +ellps=GRS80 +units=m +no_defs")

wgs84 <- CRS("+proj=longlat +datum=WGS84")

lambert_to_wgs84 <- spTransform(lambert_data, wgs84)

countryPolygons.df <- as.data.frame(lambert_to_wgs84)
```

```{r}
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x1"] <- "X"
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x2"] <- "Y"
Land_cartoISea <- select(Land_cartoISea, -X, -Y)
Land_cartoISea <- cbind(Land_cartoISea, countryPolygons.df)
Land_cartoISea_500 <- subset(Land_cartoISea, BufferSize == 500)
```

```{r}
table_jointe_tbl <- Sites %>% 
                        left_join(y = Land_cartoISea_500, 
                                  by = c("code_site" = "ID"))
```

```{r}
# carte de Bordeaux Métropole avec les points (sites) colorés en fonction du pourcentage d'artificialisation pour un buffersize de 500m
palette <- colorNumeric(palette = "magma",domain = table_jointe_tbl$MOS11,reverse=TRUE)

amp_artificial <- leaflet(data = table_jointe_tbl) %>% 
  addTiles() %>%
  addCircles(~X.y, ~Y, weight = 1, radius = ~BufferSize, color = ~palette(MOS11), opacity = 1, fillOpacity = 0.5, popup = ~name_site)

amp_artificial <- amp_artificial %>% addLegend(position = "bottomright", pal = palette, values = ~MOS11, title = "MOS11", opacity = 1)

amp_artificial
```

```{r}
data_join <- Oiseaux %>% left_join(y = Land_cartoISea_500, by = c("Code_Maille" = "ID"))

res <- data_join %>%
  group_by(MOS11, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res, aes(x = MOS11, y = Nb_espece, color = Year)) +
  geom_point() +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation")
```
```{r}
res_2018 <- res %>% filter(Year == 2018)
ggplot(data = res_2018, aes(x = MOS11, y = Nb_espece)) +
  geom_point(color = "blue") +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation \n(année 2018)")
```
```{r}
res_2018 <- res %>% filter(Year == 2019)
ggplot(data = res_2018, aes(x = MOS11, y = Nb_espece)) +
  geom_point(color = "blue") +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation \n(année 2019)")
```
```{r}
res_2018 <- res %>% filter(Year == 2022)
ggplot(data = res_2018, aes(x = MOS11, y = Nb_espece)) +
  geom_point(color = "blue") +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation \n(année 2022)")
```
```{r}
res_2018 <- res %>% filter(Year == 2023)
ggplot(data = res_2018, aes(x = MOS11, y = Nb_espece)) +
  geom_point(color = "blue") +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation \n(année 2023)")
```
```{r}
data_2018 <- data_join %>%
  filter(Year == 2018)

res_temperature <- data_2018 %>%
  group_by(Temperature, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_temperature, aes(x = Temperature, y = Nb_espece, color = as.factor(Year))) +
  geom_point() +
  geom_line() +
  labs(x = "Température",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la température (année 2018)")
```
```{r}
data_2019 <- data_join %>%
  filter(Year == 2019)

res_temperature <- data_2019 %>%
  group_by(Temperature, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_temperature, aes(x = Temperature, y = Nb_espece, color = as.factor(Year))) +
  geom_point() +
  geom_line() +
  labs(x = "Température",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la température (année 2019)")
```
```{r}
data_2022 <- data_join %>%
  filter(Year == 2022)

res_temperature <- data_2022 %>%
  group_by(Temperature, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_temperature, aes(x = Temperature, y = Nb_espece, color = as.factor(Year))) +
  geom_point() +
  geom_line() +
  labs(x = "Température",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la température (année 2022)")
```
```{r}
data_2023 <- data_join %>%
  filter(Year == 2023)

res_temperature <- data_2023 %>%
  group_by(Temperature, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_temperature, aes(x = Temperature, y = Nb_espece, color = as.factor(Year))) +
  geom_point() +
  geom_line() +
  labs(x = "Température",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la température (année 2023)")
```
```{r}
# Convertir la colonne "Vent" en facteur
data_join$Vent <- factor(data_join$Vent, levels = c("0 - Calme", "1 - Très légère brise", "2 - Légère brise", "3 - Petite brise"))

# Créer un résumé du nombre d'espèces par niveau de vent
res_vent <- data_join %>%
  group_by(Vent) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_vent, aes(x = Vent, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Vent",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du niveau de vent")
```
```{r}
res_vent <- data_join %>%
  filter(Year == 2018) %>%
  group_by(Vent) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_vent, aes(x = Vent, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Vent",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du niveau de vent (année 2018)")
```
```{r}
res_vent <- data_join %>%
  filter(Year == 2019) %>%
  group_by(Vent) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_vent, aes(x = Vent, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Vent",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du niveau de vent (année 2019)")
```
```{r}
res_vent <- data_join %>%
  filter(Year == 2022) %>%
  group_by(Vent) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_vent, aes(x = Vent, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Vent",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du niveau de vent (année 2022)")
```
```{r}
res_vent <- data_join %>%
  filter(Year == 2023) %>%
  group_by(Vent) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_vent, aes(x = Vent, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Vent",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du niveau de vent (année 2023)")
```
```{r}
niveaux <- c("0-25%", "25-50%", "50-75%", "75-100%", "100,00 %", "Aucun")
valeurs_numeriques <- c(1, 2, 3, 4, 5, 6)
data_join$Couvert_Nuageux_factor <- factor(data_join$Couvert_Nuageux, levels = niveaux)
data_join$Couvert_Nuageux_factor <- valeurs_numeriques[match(data_join$Couvert_Nuageux_factor, niveaux)]
```

```{r}
# Créer un résumé du nombre d'espèces par niveau de couverture nuageuse
res_couverture_nuageuse <- data_join %>%
  group_by(Couvert_Nuageux_factor) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_couverture_nuageuse, aes(x = Couvert_Nuageux_factor, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Couverture Nuageuse",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la couverture nuageuse")
```
```{r}
res_couverture_nuageuse_2018 <- data_join %>%
  filter(Year == 2018) %>%
  group_by(Couvert_Nuageux_factor) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_couverture_nuageuse_2018, aes(x = Couvert_Nuageux_factor, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Couverture Nuageuse",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la couverture nuageuse (année 2018)")
```
```{r}
res_couverture_nuageuse_2019 <- data_join %>%
  filter(Year == 2019) %>%
  group_by(Couvert_Nuageux_factor) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_couverture_nuageuse_2019, aes(x = Couvert_Nuageux_factor, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Couverture Nuageuse",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la couverture nuageuse (année 2019)")
```
```{r}
res_couverture_nuageuse_2022 <- data_join %>%
  filter(Year == 2022) %>%
  group_by(Couvert_Nuageux_factor) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_couverture_nuageuse_2022, aes(x = Couvert_Nuageux_factor, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Couverture Nuageuse",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la couverture nuageuse (année 2022)")
```
```{r}
res_couverture_nuageuse_2023 <- data_join %>%
  filter(Year == 2023) %>%
  group_by(Couvert_Nuageux_factor) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res_couverture_nuageuse_2023, aes(x = Couvert_Nuageux_factor, y = Nb_espece)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(x = "Couverture Nuageuse",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction de la couverture nuageuse (année 2023)")
```
```{r}
data_join$Vent_nombre <- as.numeric(gsub("\\D", "", data_join$Vent))
data_join
```
```{r}
# ACP des variables explicatives et nb_espece
variables <- data_join %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
#ACP de MOS11 et nb_espece
variables <- data_join %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
#ACP des variables explicatives et nb_espece en 2018
variables <- data_join %>%
  filter(Year == 2018) %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
```

```{r}
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
#ACP de MOS11 et nb_espece en 2018
variables <- data_join %>%
  filter(Year == 2018) %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
#ACP des variables explicatives et nb_espece en 2019
variables <- data_join %>%
  filter(Year == 2019) %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

```{r}
#ACP de MOS11 et nb_espece en 2019
variables <- data_join %>%
  filter(Year == 2019) %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

```{r}
#ACP des variables explicatives et nb_espece en 2022
variables <- data_join %>%
  filter(Year == 2022) %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

```{r}
#ACP de MOS11 et nb_espece en 2022
variables <- data_join %>%
  filter(Year == 2022) %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

```{r}
#ACP des variables explicatives et nb_espece en 2023
variables <- data_join %>%
  filter(Year == 2023) %>%
  select(MOS11, Temperature, Couvert_Nuageux_factor, Vent_nombre, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

```{r}
#ACP de MOS11 et nb_espece en 2023
variables <- data_join %>%
  filter(Year == 2023) %>%
  select(MOS11, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```
```{r}
# carte de Bordeaux Métropole avec les points (sites) colorés en fonction du pourcentage d'artificialisation pour un buffersize de 2000m
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x1"] <- "X"
colnames(countryPolygons.df)[colnames(countryPolygons.df) == "coords.x2"] <- "Y"
Land_cartoISea <- select(Land_cartoISea, -X, -Y)
Land_cartoISea <- cbind(Land_cartoISea, countryPolygons.df)
Land_cartoISea_2000 <- subset(Land_cartoISea, BufferSize == 2000)
table_jointe_tbl <- Sites %>% 
                        left_join(y = Land_cartoISea_2000, 
                                  by = c("code_site" = "ID"))

palette <- colorNumeric(palette = "magma",domain = table_jointe_tbl$MOS11,reverse = TRUE)

amp_artificial <- leaflet(data = table_jointe_tbl) %>% 
  addTiles() %>%
  addCircles(~X.y, ~Y, weight = 1, radius = ~BufferSize, color = ~palette(MOS11), opacity = 1, fillOpacity = 0.5, popup = ~name_site)

amp_artificial <- amp_artificial %>% addLegend(position = "bottomright", pal = palette, values = ~MOS11, title = "MOS11", opacity = 1)

amp_artificial
```

```{r}
data_join <- Oiseaux %>% left_join(y = Land_cartoISea_2000, by = c("Code_Maille" = "ID"))

res <- data_join %>%
  group_by(MOS11, Year) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')

ggplot(data = res, aes(x = MOS11, y = Nb_espece, color = Year)) +
  geom_point() +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "Nombre d'espèces",
       title = "Nombre d'espèces différentes en fonction du pourcentage d'artificialisation")
```
## Si on prend le BufferSize comme une donnée quelconque, est-ce que ce dernier à un impact sur le nombre d'espèces qu'on observe ?

```{r}
data_join <- Oiseaux %>% left_join(y = Land_cartoISea, by = c("Code_Maille" = "ID"))
data_join
```

```{r}
#ACP de MOS11, BufferSize et nb_espece
variables <- data_join %>%
  select(MOS11, BufferSize, Nom_Latin) %>%
  na.omit()
data_aggregated <- variables %>%
  group_by(MOS11) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))
data_final <- left_join(variables, data_aggregated, by = "MOS11")
variables <- data_final %>%
  select(-Nom_Latin)
variables_std <- scale(variables)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

# La biodiversité réagit-elle à d'autres catégories d’usage du sol ?

```{r}
## ACP sur les variables MOS et le nombre d’espèces d’oiseaux

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join <- Oiseaux %>% 
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID"))

data_join <- data_join %>% 
  left_join(Sites, by = c("Code_Maille" = "code_site"))

data_aggregated <- data_join %>%
  group_by(name_site) %>%
  summarise(Nb_espece = n_distinct(Nom_Latin))

data_final <- left_join(data_join, data_aggregated, by = "name_site")

data_acp <- data_final[, c("Nb_espece", paste0("MOS", 1:14))]

data_acp_clean <- data_acp[, apply(data_acp, 2, function(x) !all(is.na(x)) & length(unique(x)) > 1)]

variables_std <- scale(data_acp_clean)
acp <- PCA(variables_std, scale = TRUE)
summary(acp)
```

```{r}
create_plot <- function(MOS, x_label) {
  data_join <- Oiseaux %>% left_join(y = Land_cartoISea_500, by = c("Code_Maille" = "ID"))
  res <- data_join %>%
    group_by({{MOS}}, Year) %>%
    summarise(Nb_espece = n_distinct(Nom_Latin), .groups = 'drop')
  
  ggplot(data = res, aes(x = {{MOS}}, y = Nb_espece, color = Year)) +
    geom_point() +
    geom_smooth(method = "auto", se = TRUE, color = "black") +
    labs(x = x_label,
         y = "Nb_especes")+
    theme(legend.position = "none")
}

plot1 <- create_plot(MOS1, "MOS1 %")
plot2 <- create_plot(MOS2, "MOS2 %")
plot3 <- create_plot(MOS4, "MOS4 %")
plot4 <- create_plot(MOS5, "MOS5 %")
plot5 <- create_plot(MOS6, "MOS6 %")
plot6 <- create_plot(MOS8, "MOS8 %")
plot8 <- create_plot(MOS10, "MOS10 %")
plot9 <- create_plot(MOS11, "MOS11 %")
plot10 <- create_plot(MOS12, "MOS12 %")
plot11 <- create_plot(MOS13, "MOS13 %")
plot12 <- create_plot(MOS14, "MOS14 %")

combined_plot <- plot1 + plot2 + plot3 + plot4 + plot5 + plot6 + plot8 + plot9 + plot10 + plot11 + plot12
combined_plot
```

# Formules de diversité - indice de Shannon et indice de Simpson

```{r}
# Nombre total pour chaque modalité Milieu_favori
tot_Milieu_favori <- Traits %>%
  group_by(Milieu_favori) %>%
  summarise(Total = n())

tot_Milieu_favori
```

```{r}
# Nombre d'oiseaux au total
Oiseaux_Tot <- sum(Oiseaux$Denombrement_min)
```

```{r}
proportion <- function(data, year) {
  data <- data[data$Year == year,]
  x_ij <- aggregate(data$Denombrement_min, by = list(Code_Maille = data$Code_Maille, Nom_Latin = data$Nom_Latin), FUN = sum)
  x_tot_j <- aggregate(data$Denombrement_min, by = list(Code_Maille = data$Code_Maille), FUN = sum)
  x_ij_merge <- merge(x_ij, x_tot_j, by = "Code_Maille")
  p_ij <- x_ij_merge$x.x / x_ij_merge$x.y
  
  proportions <- data.frame(Code_Maille = x_ij_merge$Code_Maille,
                            Nom_Latin = x_ij_merge$Nom_Latin,
                            Proportion = p_ij)
  
  return(proportions)
}
```

```{r}
D1 <- function(data, year) {
  data <- data[data$Year == year,]
  data <- data[data$Denombrement_min != 0,]
  s_j <- aggregate(Nom_Latin ~ Code_Maille, data = data, FUN = function(x) length(unique(x)))
  Sj <- data.frame(Code_Maille = s_j$Code_Maille,
                            S = s_j$Nom_Latin)
  return(Sj)
}
```

```{r}
exp_shannon <- function(proportions) {
  H_j <- numeric(length(unique(proportions$Code_Maille)))
  
  for (j in 1:length(unique(proportions$Code_Maille))) {
    p_ij_site <- proportions$Proportion[proportions$Code_Maille == unique(proportions$Code_Maille)[j] & proportions$Proportion > 0]
    H_j[j] <- -sum(p_ij_site * log(p_ij_site))
  }
  
  D_2 <- data.frame(Code_Maille = unique(proportions$Code_Maille), D_2 = exp(H_j))
  
  return(D_2)
}
```

```{r}
proba_simpson <- function(proportions) {
  D_3 <- numeric(length(unique(proportions$Code_Maille)))
  
  for (j in 1:length(unique(proportions$Code_Maille))) {
    p_ij_site <- proportions$Proportion[proportions$Code_Maille == unique(proportions$Code_Maille)[j] & proportions$Proportion > 0]
    D_3[j] <- 1 / sum(p_ij_site^2)
  }
  
  D_3_df <- data.frame(Code_Maille = unique(proportions$Code_Maille), D_3 = D_3)
  
  return(D_3_df)
}
```

```{r}
# tests fictifs
x <- c(0, 1, 1, 2, 5)
y <- c(2021, 2021, 2021, 2021, 2021)
fictif <- data.frame(Denombrement_min = x, Code_Maille = c('2','2','2','4','4'), Nom_Latin = c('a','b','c','d','e'), Year = y)
proportions_fictif <- proportion(fictif, 2021)
D_1_fictif <- D1(fictif, 2021)
D_2_fictif <- exp_shannon(proportions_fictif)
D_3_fictif <- proba_simpson(proportions_fictif)

proportions_fictif
D_1_fictif
D_2_fictif
D_3_fictif
```

```{r}
# Test sur tous les oiseaux
proportions_oiseaux <- proportion(Oiseaux, 2018)
D_1_oiseaux <- D1(Oiseaux, 2018)
D_2_oiseaux <- exp_shannon(proportions_oiseaux)
D_3_oiseaux <- proba_simpson(proportions_oiseaux)
proportions_oiseaux
D_1_oiseaux %>% arrange(desc(S))
D_2_oiseaux %>% arrange(desc(D_2))
D_3_oiseaux %>% arrange(desc(D_3))
```


```{r}
# Test sur une espèce d'oiseaux
especes_choisies <- as.data.frame(Oiseaux[Oiseaux$Nom_Latin %in% c('Erithacus rubecula', 'Passer domesticus'), ])
proportions_ER <- proportion(especes_choisies, 2022)
D_1_ER <- D1(especes_choisies, 2022)
D_2_ER <- exp_shannon(proportions_ER)
D_3_ER <- proba_simpson(proportions_ER)
proportions_ER
D_1_ER %>% arrange(desc(S))
D_2_ER %>% arrange(desc(D_2))
D_3_ER %>% arrange(desc(D_3))
```

```{r}
resultats_D_2_v1 <- list()
for (annee in years) {
  proportions_oiseaux <- proportion(Oiseaux, annee)
  D_2_oiseaux <- exp_shannon(proportions_oiseaux)
  moyenne_D_2 <- mean(D_2_oiseaux$D_2)
  resultats_D_2_v1[[as.character(annee)]] <- D_2_oiseaux
}

code_maille_presentes <- Reduce(intersect, lapply(resultats_D_2_v1, function(x) x$Code_Maille))
resultats_filtres <- lapply(resultats_D_2_v1, function(x) x[x$Code_Maille %in% code_maille_presentes, ])
resultats_moyenne <- lapply(resultats_filtres, function(x) mean(x$D_2))
resultats_df_D_2 <- data.frame(Année = as.integer(names(resultats_moyenne)), Moyenne_D_2 = unlist(resultats_moyenne))

ggplot(data = resultats_df_D_2, aes(x = Année, y = Moyenne_D_2)) +
  geom_line(color = "pink", size = 1.5) +
  geom_point() +
  labs(title = "Évolution de la moyenne de D_2_oiseaux par année",
       x = "Année",
       y = "Moyenne de D_2_oiseaux") +
  theme_minimal()
```

```{r}
resultats_D_2_v2 <- list()
for (annee in years) {
  proportions_oiseaux <- proportion(Oiseaux, annee)
  D_2_oiseaux <- exp_shannon(proportions_oiseaux)
  D_2_oiseaux$Année <- as.integer(annee)
  resultats_D_2_v2[[as.character(annee)]] <- D_2_oiseaux
}

D_2_annees <- do.call(rbind, resultats_D_2_v2)
D_2_annees$Année <- factor(D_2_annees$Année)

#filtrer les sites présents sur toutes les années
nombre_annees_par_site <- table(D_2_annees$Code_Maille)
nombre_total_annees <- length(unique(D_2_annees$Année))
sites_present_toutes_annees <- names(nombre_annees_par_site[nombre_annees_par_site == nombre_total_annees])
D_2_annees_filtre <- D_2_annees[D_2_annees$Code_Maille %in% sites_present_toutes_annees,]

ggplot(data = D_2_annees_filtre, aes(x = Année, y = D_2, group = Code_Maille, color = factor(Code_Maille))) +
  geom_line() +
  labs(title = "Évolution de D_2_oiseaux par année",
       x = "Année",
       y = "D_2") +
  theme_minimal() +
  theme(legend.position = "none")

D_2_annees_filtre <- D_2_annees[D_2_annees$Code_Maille %in% sites_present_toutes_annees,]

ggplot(data = D_2_annees_filtre, aes(x = D_2, fill = factor(Année))) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution de l'indice D_2 par année",
       x = "D_2",
       y = "Densité") +
  scale_fill_brewer(palette = "Set3") + 
  theme_minimal() +
  facet_wrap(~ Année)
```

```{r}
data_D2_join <- D_2_annees_filtre %>% left_join(y = Land_cartoISea, by = c("Code_Maille" = "ID"))

ggplot(data = data_D2_join, aes(x = MOS11, y = D_2, color = Année)) +
  geom_point() +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "indice D2",
       title = "Indice de diversité D2 en fonction du pourcentage d'artificialisation")
```

```{r}
resultats_D_3_v1 <- list()
for (annee in years) {
  proportions_oiseaux <- proportion(Oiseaux, annee)
  D_3_oiseaux <- proba_simpson(proportions_oiseaux)
  moyenne_D_3 <- mean(D_3_oiseaux$D_3)
  resultats_D_3_v1[[as.character(annee)]] <- D_3_oiseaux
}

code_maille_presentes <- Reduce(intersect, lapply(resultats_D_3_v1, function(x) x$Code_Maille))
resultats_filtres <- lapply(resultats_D_3_v1, function(x) x[x$Code_Maille %in% code_maille_presentes, ])
resultats_moyenne <- lapply(resultats_filtres, function(x) mean(x$D_3))
resultats_df_D_3 <- data.frame(Année = as.integer(names(resultats_moyenne)), Moyenne_D_3 = unlist(resultats_moyenne))

ggplot(data = resultats_df_D_3, aes(x = Année, y = Moyenne_D_3)) +
  geom_line(color = "pink", size = 1.5) +
  geom_point() +
  labs(title = "Évolution de la moyenne de D_3_oiseaux par année",
       x = "Année",
       y = "Moyenne de D_3_oiseaux") +
  theme_minimal()
```

```{r}
resultats_D_3_v2 <- list()
for (annee in years) {
  proportions_oiseaux <- proportion(Oiseaux, annee)
  D_3_oiseaux <- proba_simpson(proportions_oiseaux)
  D_3_oiseaux$Année <- as.integer(annee)
  resultats_D_3_v2[[as.character(annee)]] <- D_3_oiseaux
}

D_3_annees <- do.call(rbind, resultats_D_3_v2)
D_3_annees$Année <- factor(D_3_annees$Année)

#filtrer les sites présents sur toutes les années
nombre_annees_par_site <- table(D_3_annees$Code_Maille)
nombre_total_annees <- length(unique(D_3_annees$Année))
sites_present_toutes_annees <- names(nombre_annees_par_site[nombre_annees_par_site == nombre_total_annees])
D_3_annees_filtre <- D_3_annees[D_3_annees$Code_Maille %in% sites_present_toutes_annees,]

ggplot(data = D_3_annees_filtre, aes(x = Année, y = D_3, group = Code_Maille, color = factor(Code_Maille))) +
  geom_line() +
  labs(title = "Évolution de D_3 par sites au cours des années",
       x = "Année",
       y = "D_3") +
  theme_minimal() +
  theme(legend.position = "none")


D_3_annees_filtre <- D_3_annees[D_3_annees$Code_Maille %in% sites_present_toutes_annees,]

ggplot(data = D_3_annees_filtre, aes(x = D_3, fill = factor(Année))) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution de l'indice D_3 par année",
       x = "D_3",
       y = "Densité") +
  scale_fill_brewer(palette = "Set3") + 
  theme_minimal() +
  facet_wrap(~ Année)
```

```{r}
data_D3_join <- D_3_annees_filtre %>% left_join(y = Land_cartoISea, by = c("Code_Maille" = "ID"))

ggplot(data = data_D3_join, aes(x = MOS11, y = D_3, color = Année)) +
  geom_point() +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  labs(x = "Surfaces artificialisées en % (MOS11)",
       y = "indice D3",
       title = "Indice de diversité D3 en fonction du pourcentage d'artificialisation")
```

# La forme de la relation est-elle similaire si on considère non plus l’imperméabilisation du sol mais plutôt la distance au centre ville, sachant que ces deux métriques sont corrélées? On pourra considérer Pey-Berland le centre ville et utiliser le package sf.

```{r}
data_join_1 <- Oiseaux %>% 
  left_join(Traits, by = c("Nom_Latin" = "Nom.latin"))

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join_2 <- data_join_1 %>%
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID"))

donnees_agregate2 <- aggregate(Nom_Latin ~ MOS11 + Year + Régime.alimentaire, data = data_join_2, FUN = function(x) length(unique(x)))

donnees_agregate2$Year <- factor(donnees_agregate2$Year)

ggplot(data = donnees_agregate2, aes(x = MOS11, y = Nom_Latin, color = Régime.alimentaire)) +
  geom_point(color = "grey") +
  geom_smooth(method = "auto", se = TRUE, color = "black") + 
  geom_smooth(method = "lm", se = FALSE, aes(group = Régime.alimentaire), linetype = "solid") +
  xlab("Surfaces artificialisées en % (MOS11)") +
  ylab("Nombre d'espèces d'oiseaux") + 
  ggtitle("Diversité en fonction du nombre d'espèces d'oiseaux et le degré d'artificialisation en fonction du régime alimentaire") +
  scale_color_manual(name = "Régime.alimentaire", 
                     values = c("Carnivore" = "red", "Mixte" = "blue", "Végétarien" = "orange")) +
  theme_minimal()
```
```{r}
data_join_1 <- Oiseaux %>% 
  left_join(Traits, by = c("Nom_Latin" = "Nom.latin"))

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join_2 <- data_join_1 %>%
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID"))

donnees_agregate2 <- aggregate(Nom_Latin ~ MOS11 + Year + Milieu_favori, data = data_join_2, FUN = function(x) length(unique(x)))

donnees_agregate2$Year <- factor(donnees_agregate2$Year)

ggplot(data = donnees_agregate2, aes(x = MOS11, y = Nom_Latin, color = Milieu_favori)) +
  geom_point(color = "grey") +
  geom_smooth(method = "auto", se = TRUE, color = "black") + 
  geom_smooth(method = "lm", se = FALSE, aes(group = Milieu_favori), linetype = "solid") +
  xlab("Surfaces artificialisées en % (MOS11)") +
  ylab("Nombre d'espèces d'oiseaux") + 
  ggtitle("Diversité en fonction du nombre d'espèces d'oiseaux et le degré d'artificialisation en fonction du milieu favori") +
  scale_color_manual(name = "Milieu_favori", 
                     values = c("Agricole" = "red", "Forêt" = "blue", "Bâti" = "orange", "Généraliste" = "pink", "Zone humide" = "green")) +
  theme_minimal()
```

```{r}
centres_villes <- Sites %>% 
                        left_join(y = Land_cartoISea_500, 
                                  by = c("code_site" = "ID"))

centres_villes <- centres_villes %>% 
                        left_join(y = Oiseaux, 
                                  by = c("code_site" = "Code_Maille"))

centre_ville_interet <- centres_villes[centres_villes$name_site == "Bordeaux-A", ]

centre_ville_latitude <- centres_villes$X.y[centres_villes$name_site == "Bordeaux-A"]
centre_ville_longitude <- centres_villes$Y[centres_villes$name_site == "Bordeaux-A"]

centre_ville_latitude <- centre_ville_latitude[1]
centre_ville_longitude <- centre_ville_longitude[1]

centres_villes$Y <- as.numeric(centres_villes$Y)
centre_ville_latitude <- as.numeric(centre_ville_latitude)

centres_villes$distance_centre_ville <- sqrt((centres_villes$X.y - centre_ville_longitude)^2 + (centres_villes$Y - centre_ville_latitude)^2)

donnees_agregate_distance <- aggregate(Nom_Latin ~ distance_centre_ville, data = centres_villes, FUN = function(x) length(unique(x)))

ggplot(data = donnees_agregate_distance, aes(x = distance_centre_ville, y = Nom_Latin)) +
  geom_point(color = "grey") +
  geom_smooth(method = "auto", se = FALSE, color = "black") + 
  xlab("Distance par rapport au centre-ville") +
  ylab("Nombre d'espèces d'oiseaux") + 
  ggtitle("Nombre d'espèces d'oiseaux en fonction de la distance par rapport au centre-ville") +
  theme_minimal()
```

```{r}
# carte de Bordeaux Métropole avec les points (sites) colorés en fonction du nombre d'espèces pour un buffersize de 500m
data_join_1 <- Oiseaux %>% 
  left_join(Traits, by = c("Nom_Latin" = "Nom.latin"))

data_join_2 <- data_join_1 %>%
  right_join(Sites, by = c("Code_Maille" = "code_site"))

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join_2 <- data_join_2 %>%
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID"))

data_join_2$Y <- as.numeric(data_join_2$Y)
data_join_2$X.y <- as.numeric(data_join_2$X.y)

donnees_agregate <- aggregate(Nom_Latin ~ Nom_lieu + X.y + Y + BufferSize + name_site, data = data_join_2, FUN = function(x) length(unique(x)))

palette <- colorNumeric(palette = "viridis", domain = donnees_agregate$Nom_Latin,reverse = TRUE)

amp_oiseaux <- leaflet(data = donnees_agregate) %>% 
  addTiles() %>%
  addCircles(~X.y, ~Y, weight = 1, radius = ~BufferSize, color = ~palette(Nom_Latin), opacity = 1, fillOpacity = 0.5, popup = ~name_site)

amp_oiseaux <- amp_oiseaux %>% addLegend(position = "bottomright", pal = palette, values = ~Nom_Latin, title = "Nombre d'espèces", opacity = 1)
amp_oiseaux
```

```{r}
# carte de Bordeaux Métropole avec les sites representés par des piechart en fonction du mileu favori pour un buffersize de 500m de la repartiton des espèces d'oiseaux
data_join_1 <- Oiseaux %>%
  left_join(Traits, by = c("Nom_Latin" = "Nom.latin"))

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join_2 <- data_join_1 %>%
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID")) %>%
  left_join(Sites, by = c("Code_Maille" = "code_site"))

aggregated_data <- data_join_2 %>%
  group_by(X.x, Y, Year, Milieu_favori, name_site) %>%
  summarise(Nom_Latin = n_distinct(Nom_Latin)) %>%
  ungroup() %>%
  mutate(Year = factor(Year))

chartdata <- table(aggregated_data$X.x, aggregated_data$Y, aggregated_data$Milieu_favori)

colors <- c("yellow", "green", "grey", "brown", "blue")

pivot_data <- spread(aggregated_data, Milieu_favori, Nom_Latin, fill = 0)

aggregated_data <- na.omit(aggregated_data)

pivot_data <- spread(aggregated_data, Milieu_favori, Nom_Latin, fill = 0)

pivot_data <- pivot_data %>%
  ungroup()

pivot_data$total <- rowSums(select(pivot_data, -c(X.x, Y, Year, name_site)))

chart_data <- cbind(pivot_data[, c("X.x", "Y")], pivot_data[, unique(aggregated_data$Milieu_favori)], total = pivot_data$total)

colnames(chart_data) <- c("lng", "lat", unique(aggregated_data$Milieu_favori), "total")

ma_carte <- leaflet() %>%
  addTiles() %>%
  setView(lng = mean(pivot_data$X.x), lat = mean(pivot_data$Y), zoom = 10)

ma_carte <- ma_carte %>%
  addMinicharts(
    lng = chart_data$lng,
    lat = chart_data$lat,
    type = "pie",
    chartdata = chart_data[, unique(aggregated_data$Milieu_favori)],
    colorPalette = colors,
    width = 60 * sqrt(chart_data$total) / sqrt(max(chart_data$total)),
    transitionTime = 0
  )

ma_carte
```

```{r}
# Carte de Bordeaux Métropole du nombre et de la répartition des espèces d'oiseaux en fonction de leur régime alimentaire pour un buffersize de 500m
data_join_1 <- Oiseaux %>%
  left_join(Traits, by = c("Nom_Latin" = "Nom.latin"))

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join_2 <- data_join_1 %>%
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID")) %>%
  left_join(Sites, by = c("Code_Maille" = "code_site"))

aggregated_data <- data_join_2 %>%
  group_by(X.x, Y, Year, name_site, Régime.alimentaire) %>%
  summarise(Nom_Latin = n_distinct(Nom_Latin)) %>%
  ungroup() %>%
  mutate(Year = factor(Year))

aggregated_data <- aggregated_data[!is.na(aggregated_data$Régime.alimentaire), ]

chartdata <- table(aggregated_data$X.x, aggregated_data$Y, aggregated_data$Régime.alimentaire)

colors <- c("yellow", "green", "grey", "brown", "blue")

pivot_data <- spread(aggregated_data, Régime.alimentaire, Nom_Latin, fill = 0)

pivot_data$total <- rowSums(select(pivot_data, -c(X.x, Y, Year, name_site)))

chart_data <- cbind(pivot_data[, c("X.x", "Y")], pivot_data[, unique(aggregated_data$Régime.alimentaire)], total = pivot_data$total)

colnames(chart_data) <- c("lng", "lat", unique(aggregated_data$Régime.alimentaire), "total")

ma_carte <- leaflet() %>%
  addTiles() %>%
  setView(lng = mean(pivot_data$X.x), lat = mean(pivot_data$Y), zoom = 10)

ma_carte <- ma_carte %>%
  addMinicharts(
    lng = chart_data$lng,
    lat = chart_data$lat,
    type = "pie",
    chartdata = chart_data[, unique(aggregated_data$Régime.alimentaire)],
    colorPalette = colors,
    width = 60 * sqrt(chart_data$total) / sqrt(max(chart_data$total)),
    transitionTime = 0
  )

ma_carte
```

```{r}
data_join_1 <- Oiseaux %>% 
  left_join(Traits, by = c("Nom_Latin" = "Nom.latin"))

Land_cartoISea_500 <- Land_cartoISea %>%
  filter(BufferSize == 500)

data_join_2 <- data_join_1 %>%
  left_join(Land_cartoISea_500, by = c("Code_Maille" = "ID"))

donnees_agregate2 <- aggregate(Nom_Latin ~ X + Y + MOS11 + Year + Milieu_favori + Régime.alimentaire, data = data_join_2, FUN = function(x) length(unique(x)))

donnees_agregate2$Year <- factor(donnees_agregate2$Year)
donnees_agregate2

ggplot(data = donnees_agregate2, aes(x = Milieu_favori, y = MOS11, fill = Régime.alimentaire)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(x = "Milieu Favori", y = "MOS11", fill = "Régime Alimentaire") +
  ggtitle("Distribution de MOS11 par Milieu Favori et Régime Alimentaire")
```
```{r}
anova_model <- aov(MOS11 ~ Milieu_favori * Régime.alimentaire, data = donnees_agregate2)
summary(anova_model)
```

```{r}
lm_model <- lm(MOS11 ~ Milieu_favori * Régime.alimentaire, data = donnees_agregate2)
summary(lm_model)
```